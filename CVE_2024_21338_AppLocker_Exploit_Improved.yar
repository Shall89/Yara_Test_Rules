rule CVE_2024_21338_AppLocker_Exploit_Improved {
  meta:
    description = "YARA rule for potential CVE-2024-21338 AppLocker exploit code"
  strings:
    $suspicious_function1 = "DuplicateHandle"
    $suspicious_function2 = "NtQuerySystemInformation"
    $potential_ioctl_1 = "AipSmartHashImageFile_W10"
    $potential_ioctl_2 = "AipSmartHashImageFile_W11"
    $applocker_device = "\\Device\\AppID"
  condition:
    ( all of ($suspicious_function1, $suspicious_function2) or 
      ($potential_ioctl_1 or $potential_ioctl_2) )
    and $applocker_device
}
